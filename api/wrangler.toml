name = "strollcast-api"
main = "src/index.ts"
compatibility_date = "2024-12-01"
account_id = "24828d2a24b818aa2e994213d8a562c6"

[[d1_databases]]
binding = "DB"
database_name = "strollcast"
database_id = "9c9e8c33-9960-46d2-a092-7a7a239a5c5e"

# Queue for podcast generation jobs
[[queues.producers]]
queue = "strollcast-jobs"
binding = "JOBS_QUEUE"

[[queues.consumers]]
queue = "strollcast-jobs"
max_batch_size = 1
max_batch_timeout = 30
max_retries = 3
dead_letter_queue = "strollcast-jobs-dlq"

# R2 bucket for episode output (audio, transcripts, scripts)
[[r2_buckets]]
binding = "R2"
bucket_name = "strollcast-output"

# R2 bucket for segment cache
[[r2_buckets]]
binding = "R2_CACHE"
bucket_name = "strollcast-cache"

[observability]
[observability.logs]
enabled = true
head_sampling_rate = 1
invocation_logs = true
persist = true

# FFmpeg container for MP3 concatenation
# Built by Cloudflare from Dockerfile (cached internally)
[[containers]]
class_name = "FFmpegContainer"
image = "./container/Dockerfile"
max_instances = 5

[[durable_objects.bindings]]
class_name = "FFmpegContainer"
name = "FFMPEG_CONTAINER"

[[migrations]]
new_sqlite_classes = ["FFmpegContainer"]
tag = "v1"

# Environment variables
[vars]
CF_ACCOUNT_ID = "24828d2a24b818aa2e994213d8a562c6"

# Secrets (set via wrangler secret put):
# - ANTHROPIC_API_KEY: For transcript generation via Claude API
# - ELEVENLABS_API_KEY: For audio generation via ElevenLabs API
# - INWORLD_API_KEY: For Inworld TTS via AIML API
# - API_KEY: For authenticating POST /jobs requests (Bearer token)
# - GITHUB_TOKEN: For pushing scripts to strollcast/scripts repo (PAT with public_repo scope)
# - R2_ACCESS_KEY_ID: For generating presigned URLs (create at R2 > Manage R2 API Tokens)
# - R2_SECRET_ACCESS_KEY: For generating presigned URLs
