---
import Layout from '../layouts/Layout.astro';
import { getSession, ADMIN_GITHUB_USERNAME } from '../lib/auth';

const session = await getSession(Astro);

// Redirect to login if not authenticated
if (!session) {
  return Astro.redirect('/login?redirect=/admin');
}

// Check if user is admin
const username = (session.user as any)?.username;
if (username !== ADMIN_GITHUB_USERNAME) {
  return Astro.redirect('/');
}
---

<Layout title="Admin">
  <div class="admin-container">
    <div class="admin-header">
      <h1>Admin Dashboard</h1>
      <p class="subtitle">Manage podcast episodes</p>
    </div>

    <div id="episodes-list" class="episodes-list">
      <div class="loading">Loading episodes...</div>
    </div>
  </div>
</Layout>

<script>
  interface EpisodeWithMeta {
    id: string;
    title: string;
    authors: string;
    year: number;
    audioUrl: string;
    transcriptUrl: string | null;
    scriptSize: number | null;
    scriptUpdated: string | null;
    audioSize: number | null;
    audioUpdated: string | null;
    vttSize: number | null;
    vttUpdated: string | null;
  }

  function formatBytes(bytes: number | null): string {
    if (bytes === null || bytes === undefined) return '-';
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
  }

  function formatDate(dateString: string | null): string {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
    });
  }

  function truncateTitle(title: string, maxLen: number = 60): string {
    if (title.length <= maxLen) return title;
    return title.slice(0, 50) + '...' + title.slice(-10);
  }

  async function loadEpisodes() {
    const list = document.getElementById('episodes-list') as HTMLElement;

    try {
      const response = await fetch('/api/admin/episodes');
      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Failed to load episodes');
      }

      const episodes: EpisodeWithMeta[] = data.episodes || [];

      if (episodes.length === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <p>No episodes found.</p>
          </div>
        `;
        return;
      }

      list.innerHTML = `
        <table class="episodes-table">
          <thead>
            <tr>
              <th class="col-title">Title</th>
              <th class="col-year">Year</th>
              <th class="col-file">Script</th>
              <th class="col-file">Audio</th>
              <th class="col-file">VTT</th>
              <th class="col-actions">Actions</th>
            </tr>
          </thead>
          <tbody>
            ${episodes.map(ep => `
              <tr data-id="${ep.id}">
                <td class="col-title">
                  <div class="title-cell">
                    <span class="ep-title" title="${ep.title}">${truncateTitle(ep.title)}</span>
                    <span class="ep-authors">${ep.authors}</span>
                  </div>
                </td>
                <td class="col-year">${ep.year}</td>
                <td class="col-file">
                  <div class="file-cell">
                    <span class="file-size">${formatBytes(ep.scriptSize)}</span>
                    <span class="file-date">${formatDate(ep.scriptUpdated)}</span>
                  </div>
                </td>
                <td class="col-file">
                  <div class="file-cell">
                    <span class="file-size">${formatBytes(ep.audioSize)}</span>
                    <span class="file-date">${formatDate(ep.audioUpdated)}</span>
                  </div>
                </td>
                <td class="col-file">
                  <div class="file-cell">
                    <span class="file-size">${formatBytes(ep.vttSize)}</span>
                    <span class="file-date">${formatDate(ep.vttUpdated)}</span>
                  </div>
                </td>
                <td class="col-actions">
                  <div class="actions-cell">
                    <button class="btn btn-regen" data-action="regen" data-id="${ep.id}" onclick="regenerateAudio('${ep.id}')">
                      Regenerate
                    </button>
                    <button class="btn btn-delete" data-action="delete" data-id="${ep.id}" onclick="deleteAudio('${ep.id}')">
                      Delete Audio
                    </button>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;

    } catch (error) {
      list.innerHTML = `
        <div class="error-state">
          <p>Failed to load episodes: ${error instanceof Error ? error.message : 'Unknown error'}</p>
          <button onclick="loadEpisodes()" class="btn btn-secondary">Retry</button>
        </div>
      `;
    }
  }

  async function regenerateAudio(episodeId: string) {
    const btn = document.querySelector(`button[data-action="regen"][data-id="${episodeId}"]`) as HTMLButtonElement;
    const originalText = btn.textContent;

    btn.disabled = true;
    btn.textContent = 'Queueing...';

    try {
      const response = await fetch(`/api/admin/episodes/${episodeId}/regenerate-audio`, {
        method: 'POST',
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Failed to regenerate audio');
      }

      btn.textContent = 'Queued!';
      btn.classList.add('btn-success');

      setTimeout(() => {
        btn.textContent = originalText;
        btn.classList.remove('btn-success');
        btn.disabled = false;
      }, 3000);

    } catch (error) {
      btn.textContent = 'Failed';
      btn.classList.add('btn-error');

      setTimeout(() => {
        btn.textContent = originalText;
        btn.classList.remove('btn-error');
        btn.disabled = false;
      }, 3000);

      console.error('Regeneration error:', error);
    }
  }

  async function deleteAudio(episodeId: string) {
    if (!confirm(`Delete audio for "${episodeId}"? This cannot be undone.`)) {
      return;
    }

    const btn = document.querySelector(`button[data-action="delete"][data-id="${episodeId}"]`) as HTMLButtonElement;
    const originalText = btn.textContent;

    btn.disabled = true;
    btn.textContent = 'Deleting...';

    try {
      const response = await fetch(`/api/admin/episodes/${episodeId}/delete-audio`, {
        method: 'POST',
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Failed to delete audio');
      }

      btn.textContent = 'Deleted!';
      btn.classList.add('btn-success');

      // Reload to show updated state
      setTimeout(() => {
        loadEpisodes();
      }, 1000);

    } catch (error) {
      btn.textContent = 'Failed';
      btn.classList.add('btn-error');

      setTimeout(() => {
        btn.textContent = originalText;
        btn.classList.remove('btn-error');
        btn.disabled = false;
      }, 3000);

      console.error('Delete error:', error);
    }
  }

  // Make functions available globally
  (window as any).loadEpisodes = loadEpisodes;
  (window as any).regenerateAudio = regenerateAudio;
  (window as any).deleteAudio = deleteAudio;

  // Initial load
  loadEpisodes();
</script>

<style>
  .admin-container {
    max-width: 1200px;
    margin: 0 auto;
  }

  .admin-header {
    margin-bottom: 2rem;
  }

  .admin-header h1 {
    margin-bottom: 0.5rem;
  }

  .subtitle {
    color: var(--text-secondary);
    margin: 0;
  }

  .episodes-list {
    overflow-x: auto;
  }

  .loading, .empty-state, .error-state {
    text-align: center;
    padding: 3rem;
    color: var(--text-secondary);
  }

  .error-state .btn {
    margin-top: 1rem;
  }

  .episodes-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
  }

  .episodes-table th,
  .episodes-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid var(--border);
  }

  .episodes-table th {
    background: var(--bg-secondary);
    color: var(--text-secondary);
    font-weight: 500;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .episodes-table tbody tr:hover {
    background: var(--bg-card);
  }

  .col-title {
    min-width: 300px;
  }

  .col-year {
    width: 60px;
    text-align: center;
  }

  .col-file {
    width: 100px;
  }

  .col-actions {
    width: 200px;
  }

  .title-cell {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .ep-title {
    color: var(--text-primary);
    font-weight: 500;
  }

  .ep-authors {
    color: var(--text-secondary);
    font-size: 0.75rem;
  }

  .file-cell {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
  }

  .file-size {
    color: var(--text-primary);
    font-family: monospace;
    font-size: 0.75rem;
  }

  .file-date {
    color: var(--text-secondary);
    font-size: 0.7rem;
  }

  .actions-cell {
    display: flex;
    gap: 0.5rem;
  }

  .btn {
    padding: 0.375rem 0.75rem;
    border-radius: 4px;
    font-weight: 500;
    cursor: pointer;
    border: none;
    font-size: 0.75rem;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .btn-regen {
    background: var(--accent);
    color: white;
  }

  .btn-regen:hover:not(:disabled) {
    background: var(--accent-hover);
  }

  .btn-delete {
    background: transparent;
    color: #ef4444;
    border: 1px solid #ef4444;
  }

  .btn-delete:hover:not(:disabled) {
    background: rgba(239, 68, 68, 0.1);
  }

  .btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }

  .btn-success {
    background: #22c55e !important;
    border-color: #22c55e !important;
    color: white !important;
  }

  .btn-error {
    background: #ef4444 !important;
    border-color: #ef4444 !important;
    color: white !important;
  }

  .btn-secondary {
    background: var(--bg-card);
    color: var(--text-primary);
    border: 1px solid var(--border);
  }

  .btn-secondary:hover {
    background: var(--bg-secondary);
  }

  @media (max-width: 768px) {
    .episodes-table {
      font-size: 0.75rem;
    }

    .episodes-table th,
    .episodes-table td {
      padding: 0.5rem;
    }

    .col-title {
      min-width: 200px;
    }

    .actions-cell {
      flex-direction: column;
    }
  }
</style>
